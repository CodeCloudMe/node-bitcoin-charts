<html>


	<head>
		<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
		<script src="http://code.highcharts.com/highcharts.js"></script>
		<script src="http://code.highcharts.com/modules/exporting.js"></script>

		<script src="http://js.pusher.com/2.2/pusher.min.js"></script>


		<script>


		$(document).ready(function(){

			doNextExchange();

			subscribeToData();
			//getAllData();
			//makeChart();
		})


		var allData=[];
		var exchanges = ['bitfinex', 'btcchina', 'okcoin', 'bitstamp'];
		var currentExchange = 0;

		


		function subscribeToData(){


				var pusher = new Pusher('5707fad988e38a9c8ce1');
		    	var channel = pusher.subscribe('test_channel');
		    	channel.bind('my_event', function(data) {
		      		
		      		
		      		doNextExchange();
		    	});

		}

		function doNextExchange(){

			getData(exchanges[currentExchange]);
		}




		function getData(exchange){

			$.ajax({

				url:'http://bitstamp-searchgag.rhcloud.com/getAllData',
				data: {'exchange':exchange},
				
				complete:function(transport){

					var resp = transport.responseText;

					info = $.parseJSON(resp);

					//empty array we are going to make into something we can send to highcharts

					chartData=[];

					for(i in info){
						if(typeof info[i]['timestamp'] != "undefined"){

							theLast = parseFloat(info[i]['buy'] )
							if(exchange =="btcchina"){
								theLast= theLast*.16;
							}
							chartData[i]= [info[i]['timestamp'],theLast];
						}

					}

					allData.push({'name':exchange, 'data':chartData})


					currentExchange= currentExchange+1;
					if((currentExchange +1) > exchanges.length){

						makeChart(allData);
						currentExchange=0;

					}
					else{
							doNextExchange();
					}
				

					//makeChart(chartData);



					

				}

			})
		}

		function makeChart(data1){

			//show loading data indicator
			$('#container').css({

				'border-width':'2px',
				'border-style':'solid',
				'border-color':'blue'
			});

			//timeout for 2 seconds... to unshow loading indicator

			setTimeout(function(){
					$('#container').css({

					'border-width':'2px',
					'border-style':'solid',
					'border-color':'white'
					});


			}, 2000);



			$('#container').highcharts({
			        chart: {
			            type: 'spline'
			        },
			        title: {
			            text: 'Exchange prices'
			        },
			        subtitle: {
			            text: 'Metric: buy'
			        },
			       
			        xAxis: {
			           type: 'datetime'
			        },
			        yAxis: {
			            title: {
			                text: '$ (USD)'
			            }
			           
			        },
			        tooltip: {
			            crosshairs: true,
			            shared: true
			        },
			        plotOptions: {
			            spline: {
			                marker: {
			                    radius: 4,
			                    lineColor: '#666666',
			                    lineWidth: 1
			                }
			            }
			        },
			        series: data1
			    });
		}

		</script>
	</head>



	<body>

		<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

	</body>

</html>